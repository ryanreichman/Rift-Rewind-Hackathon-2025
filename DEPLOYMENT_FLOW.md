# Deployment Flow - Visual Overview

## ðŸŽ¯ The Big Picture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Local Machine  â”‚
â”‚   (Your Code)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ git push
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub                           â”‚
â”‚              (Code Repository)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                    â”‚
               â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Manual Deploy     â”‚   â”‚   Auto Deploy      â”‚
    â”‚  (Lambda)          â”‚   â”‚   (Amplify)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                    â”‚
               â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   AWS Lambda        â”‚  â”‚  AWS Amplify     â”‚
    â”‚   + API Gateway     â”‚  â”‚  (Frontend)      â”‚
    â”‚   (Backend API)     â”‚  â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                       â”‚
              â”‚                       â”‚
              â”‚  API calls            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Users access Amplify URL â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

---

## ðŸ“‹ Step-by-Step Flow

### Phase 1: Preparation (Local)
```
1. Push code to GitHub
   â””â”€â–º Triggers: Repository updated
```

### Phase 2: Backend Deploy (Manual - AWS Console)
```
2. Run ./deploy-lambda.sh
   â””â”€â–º Creates: lambda-deployment.zip

3. Create Lambda function
   â””â”€â–º Upload: lambda-deployment.zip
   â””â”€â–º Configure: Handler, timeout, memory

4. Set environment variables
   â””â”€â–º Add: Bedrock config, Knowledge Base ID, etc.

5. Add IAM permissions
   â””â”€â–º Attach: Bedrock policy to Lambda role

6. Create API Gateway
   â””â”€â–º Link: API Gateway â†’ Lambda
   â””â”€â–º Get: API Gateway URL (SAVE THIS!)

7. Test backend
   â””â”€â–º curl https://YOUR-API/api/health
```

### Phase 3: Frontend Deploy (AWS Amplify)
```
8. Connect GitHub to Amplify
   â””â”€â–º Select: Repository + Branch

9. Configure build settings
   â””â”€â–º Uses: amplify.yml
   â””â”€â–º Add: API_BASE_URL env variable (from step 6)

10. Amplify auto-builds
    â””â”€â–º Downloads code from GitHub
    â””â”€â–º Runs amplify.yml commands
    â””â”€â–º Creates config.js with API_BASE_URL
    â””â”€â–º Deploys to Amplify hosting

11. Get Amplify URL (SAVE THIS!)
    â””â”€â–º Example: https://main.xxxxx.amplifyapp.com
```

### Phase 4: Connect Frontend â†” Backend
```
12. Update Lambda CORS
    â””â”€â–º Set CORS_ORIGINS to Amplify URL (from step 11)
    â””â”€â–º Allows frontend to call backend API
```

### Phase 5: Test & Verify
```
13. Open Amplify URL
    â””â”€â–º Check: Status shows "Online"
    â””â”€â–º Test: Send message
    â””â”€â–º Verify: AI responds with streaming
```

---

## ðŸ”„ How It Works After Deployment

### User Request Flow:
```
1. User opens: https://main.xxxxx.amplifyapp.com
   â””â”€â–º Amplify serves: HTML + CSS + JS

2. Browser loads config.js
   â””â”€â–º Sets: window.API_BASE_URL to API Gateway URL

3. User sends message
   â””â”€â–º Frontend calls: https://api-gateway-url/api/chat/stream

4. API Gateway forwards to Lambda
   â””â”€â–º Lambda runs: FastAPI (via Mangum)

5. Lambda calls AWS Bedrock
   â””â”€â–º Bedrock returns: AI response (streaming)

6. Lambda streams back through API Gateway
   â””â”€â–º Frontend receives: SSE events
   â””â”€â–º UI displays: Streaming text
```

---

## ðŸ› ï¸ Files Created for Deployment

### Backend Files:
```
backend/
â”œâ”€â”€ requirements.txt          # âœ… Updated (added mangum)
â”œâ”€â”€ main.py                   # âœ… Updated (added handler)
â””â”€â”€ lambda-deployment.zip     # âš¡ Generated by deploy-lambda.sh
```

### Frontend Files:
```
frontend/
â”œâ”€â”€ index.html               # âœ… Updated (includes config.js)
â”œâ”€â”€ js/chat.js              # âœ… Updated (uses window.API_BASE_URL)
â””â”€â”€ config.js               # âœ… Created (overwritten by Amplify)
```

### Deployment Files:
```
/
â”œâ”€â”€ amplify.yml                    # âœ… Created (Amplify build spec)
â”œâ”€â”€ deploy-lambda.sh               # âœ… Created (Lambda package script)
â”œâ”€â”€ lambda-env-variables.txt       # âœ… Created (env var template)
â”œâ”€â”€ QUICK_DEPLOY_GUIDE.md         # âœ… Created (step-by-step guide)
â”œâ”€â”€ AWS_AMPLIFY_DEPLOYMENT.md     # âœ… Created (detailed guide)
â””â”€â”€ DEPLOYMENT_CHECKLIST.md       # âœ… Created (checklist)
```

---

## ðŸ”‘ Key URLs You Need

| What | Example | Where to Get It | Used For |
|------|---------|-----------------|----------|
| **API Gateway URL** | `https://abc123.execute-api.us-east-1.amazonaws.com` | Created in Step 6 | Amplify env variable |
| **Amplify URL** | `https://main.d1234.amplifyapp.com` | After Amplify deploy | Lambda CORS setting |
| **Lambda Function** | `summoners-reunion-api` | You create it | Backend processing |
| **Knowledge Base ID** | `ABC123XYZ` | From Bedrock KB setup | Lambda env variable |

---

## âš™ï¸ Environment Variables

### Lambda Environment Variables:
```
BEDROCK_MODEL_ID         â†’ Which AI model to use
KNOWLEDGE_BASE_ID        â†’ Your KB ID
CORS_ORIGINS            â†’ Your Amplify URL (allows frontend to call API)
AWS_REGION              â†’ us-east-1 (or your region)
[... see lambda-env-variables.txt for full list]
```

### Amplify Environment Variables:
```
API_BASE_URL            â†’ Your API Gateway URL (tells frontend where backend is)
```

---

## ðŸ”„ Update Flow

### When you update FRONTEND code:
```
1. Make changes to frontend files
2. git add . && git commit -m "Update" && git push
3. Amplify automatically rebuilds and deploys
4. Done! (usually 2-3 minutes)
```

### When you update BACKEND code:
```
1. Make changes to backend files
2. Run: ./deploy-lambda.sh
3. Go to Lambda Console
4. Upload new lambda-deployment.zip
5. Done! (usually 1 minute)
```

---

## ðŸš¨ Common Issues & Quick Fixes

| Issue | Symptom | Fix |
|-------|---------|-----|
| **CORS Error** | Console error about CORS | Update Lambda CORS_ORIGINS to exact Amplify URL |
| **Offline Status** | Green dot doesn't appear | Check API_BASE_URL in Amplify, test API Gateway |
| **403 Forbidden** | API returns 403 | Check IAM role has Bedrock permissions |
| **Timeout** | Request takes >30s | Increase Lambda timeout to 60s |
| **Build Fails** | Amplify build fails | Check API_BASE_URL env var is set |

---

## ðŸ“Š Cost Breakdown

### Free Tier (First 12 months):
```
Lambda:        1M requests/month free
API Gateway:   1M requests/month free
Amplify:       1000 build minutes free + 15GB served free
```

### After Free Tier (estimated for 1,000 messages/month):
```
Lambda:        ~$0.20
API Gateway:   ~$1.00
Amplify:       ~$1-2
Bedrock:       Variable (main cost)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:         ~$2-5/month + Bedrock usage
```

---

## âœ… Deployment Success Criteria

Your deployment is successful when ALL of these are true:

- âœ… Lambda health endpoint returns `{"status":"healthy"}`
- âœ… API Gateway URL is accessible
- âœ… Amplify build completes without errors
- âœ… Frontend loads and shows "Online" status
- âœ… Messages can be sent and AI responds
- âœ… No CORS errors in browser console
- âœ… CloudWatch shows no Lambda errors
- âœ… Streaming works (text appears progressively)

---

## ðŸ“– Quick Reference Commands

### Test Backend:
```bash
curl https://YOUR-API-URL/api/health
```

### Create Lambda Package:
```bash
./deploy-lambda.sh
```

### Push to GitHub:
```bash
git add . && git commit -m "Deploy" && git push
```

### View Lambda Logs:
```bash
aws logs tail /aws/lambda/summoners-reunion-api --follow
```

---

## ðŸŽ¯ Next Steps After Deployment

1. **Set up monitoring:**
   - CloudWatch alarms for errors
   - Billing alerts

2. **Add custom domain** (optional):
   - Amplify â†’ Domain management
   - Add your domain

3. **Improve security:**
   - Enable authentication
   - Add rate limiting
   - Use WAF for API Gateway

4. **Optimize costs:**
   - Monitor Bedrock usage
   - Set up billing alerts
   - Review CloudWatch log retention

---

## ðŸ“ž Getting Help

If you run into issues:

1. **Check the guides:**
   - QUICK_DEPLOY_GUIDE.md (step-by-step)
   - AWS_AMPLIFY_DEPLOYMENT.md (detailed)
   - DEPLOYMENT_CHECKLIST.md (checklist)

2. **Check logs:**
   - Browser console (F12)
   - CloudWatch Logs (Lambda)
   - Amplify build logs

3. **Verify settings:**
   - Lambda env variables
   - Amplify env variables
   - IAM permissions
   - CORS configuration

---

**Ready to deploy?** Start with **QUICK_DEPLOY_GUIDE.md**! ðŸš€
